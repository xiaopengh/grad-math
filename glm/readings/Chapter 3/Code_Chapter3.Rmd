---
title: "Linear Models and Their Generalizations"
subtitle: "Code Chapitre 3"
author: "Katia Meziani"
output:
  html_document:
    self_contained: true
    math_method: 
      engine: mathjax
      url: https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js
    code_folding: hide
    css: ./style.css
    df_print: paged
    highlight: tango
    number_sections: no
    theme: flatly
    toc: yes
    toc_float:
      collapsed: no

---



\newcommand{\rank}{\text{Rank}}

\newcommand{\bX}{\boldsymbol{X}}
\newcommand{\bx}{\boldsymbol{x}}

\newcommand{\bY}{\boldsymbol{Y}}
\newcommand{\by}{\boldsymbol{y}}
\def \e{\epsilon}
\newcommand{\be}{\boldsymbol{\epsilon}}
\newcommand{\bmu}{\boldsymbol{\mu}}
\newcommand{\btheta}{\boldsymbol{\theta}}
\newcommand{\balpha}{\boldsymbol{\alpha}}

\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\1}{\mathbb{1}}
\newcommand{\I}{\mathbf{I}}

\newcommand{\cH}{\mathscr{H}}
\newcommand{\cN}{\mathscr{N}}

\newcommand{\fisher}{{\Large{\mathscr{F}}}}

\newcommand{\RSS}{\text{RSS}}
\newcommand{\TSS}{\text{TSS}}


<style>
  .attention {
    font-size: 24px;
    color: red;
    font-weight: bold;
  }
  
  

  
<style>
  .center {
    text-align: center;
  }
</style>

  
</style>
  <style>
    .underline {
      text-decoration: underline;
    }
  </style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message=FALSE,fig.align = 'center')
```

```{r, include = F}
if (names(rmarkdown::metadata$output) == "learnr::tutorial") {
  library(learnr)
  learnr::initialize_tutorial()
  static <- FALSE
}

if (names(rmarkdown::metadata$output) == "html_document") {
  knitr::opts_hooks$set(eval = function(opt) {
    if (any(opt$exercise))
      opt$eval <- opt$include <- FALSE
    
    opt
  })
  
  static <- TRUE
  
  options(width = 100)
}
```



<style contenteditable>
  .brd {
    border: 2px solid black; ; padding: 5px
  }
</style>





<style contenteditable>
  .brdred {
    border: 2px solid #B22222 ; 
    padding: 10px; /* Ajouter de l'espace autour du texte */
    background-color: #f9f9f9; /* Optionnel : couleur de fond pour le texte */
    margin: 10px 0; /* Ajouter de l'espace au-dessus et en-dessous de l'encadrement */
  }
</style>




<style>
  .solution {
    font-size: 24px;
    color: yellow; /* Couleur jaune pour simuler la lumiÃ¨re */
  }
</style>


  <style>
    .underline {
      text-decoration: underline;
    }
  </style>


<style>
  .brdgreen {
    border: 2px solid green; /* Bordure verte */
    padding: 10px; /* Espace interne */
    background-color: rgba(114, 213, 114, 0.03); /* Fond vert pastel trÃ¨s clair avec transparence */
    margin: 10px 0; /* Espace autour de l'encadrement */
  }
</style>
   
<style>
  .brdblack {
    border: 2px solid black; /* DÃ©finir la couleur et l'Ã©paisseur de la bordure */
    padding: 10px; /* Ajouter de l'espace autour du texte */
    background-color: #f9f9f9; /* Optionnel : couleur de fond pour le texte */
    margin: 10px 0; /* Ajouter de l'espace au-dessus et en-dessous de l'encadrement */
  }
</style>



<style>
  .brdblackempty {
    border: 2px solid black; /* DÃ©finir la couleur et l'Ã©paisseur de la bordure */
    padding: 10px; /* Ajouter de l'espace autour du texte */
    /*background-color: #f9f9f9;  Optionnel : couleur de fond pour le texte */
    margin: 10px 0; /* Ajouter de l'espace au-dessus et en-dessous de l'encadrement */
  }
</style>







## Intima media dataset 

We will work throughout this chapter with the Intima Media dataset.

**Atherosclerosis** is the leading cause of death for men over 35 and women over 45 in most developed countries. It manifests as a thickening and loss of elasticity in the inner walls of the arteries, leading to conditions like myocardial infarction. The arterial wall consists of three layers: the intima, media, and adventitia. **The thickness of the intima-media layer** is a recognized **marker of atherosclerosis**. This measurement was taken ultrasonically from a sample of 110 subjects in 1999 at the Bordeaux University Hospital. Additionally, information about key risk factors, including **smoking** and **alcohol** consumption, was collected from the patients.

```{r eval=FALSE}
library(dbplyr)
marqueur<-read.csv("Intima_Media1.csv")
marqueur$tabac=as.factor(marqueur$tabac)
marqueur$alcool=as.factor(marqueur$alcool)
marqueur$SEXE=as.factor(marqueur$SEXE)
marqueur%>%rmarkdown::paged_table()
```


#  Part 1:  ANOVA single-factor model





```{r eval=FALSE,   out.width = "65%", message=FALSE, warning=FALSE}
library(ggplot2)
ggplot(marqueur, aes(y=mesure, x=alcool,colour=alcool ,fill=alcool))+
geom_boxplot(alpha=0.5, outlier.alpha=0)+geom_jitter(width=0.25,size=1)+
stat_summary(fun=mean, colour="black", geom="point",shape=18, size=3)

```



***



```{r eval=FALSE}

Plan_alcool <- as.data.frame(table(marqueur$alcool))
colnames(Plan_alcool) <- c("alcool", "Counts")
Plan_alcool %>%kableExtra::kbl() %>%kableExtra::kable_styling()


```



***


<span style="color: blue;"><span style="font-size: 17px;"> **Empirical means.** </span></span> 


To display the empirical mean (EM) for each group defined by the factor `alcool`, we can use the following code.

```{r eval=FALSE}
moy_j<-tapply(marqueur$mesure,list(Alcool=marqueur$alcool), mean)
knitr::kable(moy_j,col.names =c("alcool","Empirical mean"))%>%kableExtra::kable_styling()
```




Given that the experimental design is unbalanced, the empirical mean $\overline{Y}_{\cdot\cdot}$ of the entire variable `mesure`, is calculated as:
```{r eval=FALSE}
mean(marqueur$mesure)
```




***


<span style="color: blue;"><span style="font-size: 17px;"> **Implement constraint with $\mu=0$** </span></span> 


```{r eval=FALSE}
mod0<-lm(mesure~-1+alcool,data=marqueur);mod0
```



***

<span style="color: blue;"><span style="font-size: 17px;"> **Implement constraint with $\alpha_1=0$ (by default)** </span></span> 



```{r eval=FALSE}
mod1<-lm(mesure~alcool, data=marqueur);mod1
```



<span class="probleme">ðŸ“Œ</span> **Note**: that for $k=2$

```{r eval=FALSE}
#marqueur$alcool = relevel(marqueur$alcool, ref="RegD")
#mod2<-lm(mesure~alcool, data=marqueur)
```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Implement constraint with $\sum_{j=1}^J \alpha_j = 0$** </span></span> 



```{r eval=FALSE}
modCS<-lm(mesure~alcool,contrasts=list(alcool="contr.sum"),data=marqueur);modCS
 
```



***

```{r eval=FALSE}
summary(mod1)
```


***


```{r eval=FALSE}
library(ggfortify)
autoplot(mod1,1:4)
```


##  Comparison of Modalities





<span class="solution"><span style="color: blue;">**â“‡**</span> </span>  
**Example** Let's examine the influence of the `Statut` of a tree (alder trees) on its `Diametre`. The `Statut` has three modalities: `codominant` (the same height as one or more neighboring trees), `dominant` (taller than neighboring trees), and `dominated` (shorter than one or more neighboring trees). We can visualize this relationship using a boxplot:

```{r eval=FALSE, echo=TRUE, out.width = "80%", message=FALSE, warning=FALSE}
library(ggplot2)

# Load the data
arbres = read.table("arbres.txt", header=FALSE, sep="")
colnames(arbres) = c("Diametre", "Statut")

# Create the boxplot with jitter
ggplot(arbres, aes(y=Diametre, x=Statut, colour=Statut, fill=Statut)) +
  geom_boxplot(alpha=0.5, outlier.alpha=0) +
  geom_jitter(width=0.25) +
  stat_summary(fun=mean, colour="black", geom="point", shape=18, size=3)
```





```{r eval=FALSE}
pairwise.t.test(arbres$Diametre, arbres$Statut,
                 p.adjust.method="bonferroni")
```


# Part 2: ANOVA 2-factors model





```{r eval=FALSE}
table(marqueur$alcool,marqueur$tabac)%>%knitr::kable() 


```

<span class="solution">ðŸ“ˆ</span>   The plan is complete and unbalanced

```{r eval=FALSE,   out.width = "65%", message=FALSE, warning=FALSE}
library(ggplot2)
ggplot(marqueur, aes(y=mesure, x=tabac,colour=tabac ,fill=tabac))+
geom_boxplot(alpha=0.5, outlier.alpha=0)+geom_jitter(width=0.25,size=1)+
stat_summary(fun=mean, colour="black", geom="point",shape=18, size=3)

```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Empirical means** </span></span> 



```{r eval=FALSE}
moy_jk<-tapply(marqueur$mesure,list(Tabac=marqueur$tabac,Alcool=marqueur$alcool), mean)
knitr::kable(moy_jk)
```

```{r eval=FALSE}
ybar<-mean(marqueur$mesure)
```


***

```{r eval=FALSE}
EM_EM_j=colMeans(moy_jk)
EM_EM_j=as.data.frame(EM_EM_j)
names(EM_EM_j)="EM of the EM per cell (j,k) having modality j"
knitr::kable(EM_EM_j)
```


***

```{r eval=FALSE}
EM_EM_k=rowMeans(moy_jk)
EM_EM_k=as.data.frame(EM_EM_k)
names(EM_EM_k)=" EM of the EM per cell (j,k) having modality k"
knitr::kable(EM_EM_k)
```

 
***

```{r eval=FALSE}
EM_j=tapply(marqueur$mesure,list(Alcool=marqueur$alcool),mean)
EM_j=as.data.frame(EM_j)
names(EM_j)="EM of the observations having modality j"
knitr::kable(EM_j)
```


***

```{r eval=FALSE}
EM_k=tapply(marqueur$mesure,list(Tabac=marqueur$tabac),mean,na.rm=TRUE)
EM_k=as.data.frame(EM_k)
names(EM_k)="EM of the observations having modality k"
knitr::kable(EM_k)
```



***


<span style="color: blue;"><span style="font-size: 17px;"> **Implement sum constraints** </span></span> 


$$
\sum_{j=1}^J\alpha_j=\sum_{k=1}^K\beta_k=\sum_{j=1}^J\gamma_{jk'}=\sum_{k=1}^K\gamma_{j'k}=0, \quad\forall j',\,k'.
$$


```{r eval=FALSE}
MOD<-lm(mesure~alcool*tabac,contrasts=list(tabac="contr.sum",alcool="contr.sum"),data=marqueur)
summary(MOD)
```



##  Tests


***

<span style="color: blue;"><span style="font-size: 17px;"> **Type I Analysis.**</span></span>


```{r eval=FALSE}
mod_full<-lm(mesure~alcool*tabac, data=marqueur)
anova(mod_full)
```


```{r eval=FALSE}

mod_full_2<-lm(mesure~tabac*alcool, data=marqueur)
anova(mod_full_2)
```


***


<span style="color: blue;"><span style="font-size: 17px;"> **Type II Analysis.** </span></span> 

```{r eval=FALSE}
library(car)
Anova(mod_full)
```



#  Part 3:   ANCOVA single-factor model


***

```{r eval=FALSE}

Plan_alcool <- as.data.frame(table(marqueur$alcool))
colnames(Plan_alcool) <- c("alcool", "Counts")
Plan_alcool %>%kableExtra::kbl() %>%kableExtra::kable_styling()


```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Implement Contrast treatment:  $\alpha_1=c1=0$ (by default)** </span></span>



```{r eval=FALSE}
mod1<-lm(mesure~alcool*AGE, data=marqueur)#;mod1
summary(mod1)
```



# Tests


***

<span style="color: blue;"><span style="font-size: 17px;"> **Type I Analysis.**</span></span>

```{r eval=FALSE}
mod_full<-lm(mesure~alcool*AGE, data=marqueur)
anova(mod_full)
```


```{r eval=FALSE}

mod_full_2<-lm(mesure~AGE*alcool, data=marqueur)
anova(mod_full_2)
```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Type II Analysis.** </span></span> 

```{r eval=FALSE}
library(car)
Anova(mod_full)
```

<span class="solution">ðŸ“ˆ</span>  The regressor `AGE` has a strong impact  and the factor `alcool`is less significant. The interaction is  not significant (`Pr(>F)`>5\%). 


# What about the full dataset ?



```{r eval=FALSE}
MOD0<-lm(mesure~1,data=marqueur)
MOD1<-lm(mesure~alcool+tabac+ SEXE+AGE+taille+poids,data=marqueur)
```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Model selection using stepwise AIC** </span></span> 



```{r eval=FALSE}
library(MASS)
modBoth<-stepAIC(MOD0, mesure~SEXE+AGE+taille+poids+tabac+alcool,trace=F, direction=c("both"))
#modForw<-stepAIC(MOD0, mesure~SEXE+AGE+taille+poids+tabac+alcool,trace=F, direction=c('forward'))
#modBack<-stepAIC(MOD1,~.,trace=F,direction=c("backward"))
# Anova(MOD1)
modBoth
```




***

<span style="color: blue;"><span style="font-size: 17px;"> **Analysis of variance (ANOVA) with Type I approach** </span></span> 

```{r eval=FALSE}
anova(MOD1)
```




***

<span style="color: blue;"><span style="font-size: 17px;"> **Model comparison** </span></span>  



```{r eval=FALSE}
MODanova <- lm(mesure ~ alcool + AGE + poids, data = marqueur) 
Comparaison<-c("modBoth vs MODanova","modBoth vs MODanova")
P_value<-c(anova(modBoth, MODanova)$`Pr(>F)`[2] ,anova(modBoth,MOD1)$`Pr(>F)`[2])
cbind.data.frame(Comparaison,P_value)

```



```{r eval=FALSE}
AIC(modBoth, MODanova, MOD1)
```
 


***

<span style="color: blue;"><span style="font-size: 17px;"> **Final Selected Model**: `modBoth` </span></span> 


```{r eval=FALSE}
summary(modBoth)
```


***

<span style="color: blue;"><span style="font-size: 17px;"> **Diagnostic Plots for Model** </span></span>




```{r eval=FALSE}
library(ggfortify)
autoplot(modBoth,1:4)
```




